<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Family Chores</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            position: relative;
        }

        .header-nav {
            position: absolute;
            top: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        h1 {
            font-size: 36px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        .setting-item {
            margin-bottom: 32px;
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .setting-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        .setting-subtitle {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }     

        .setting-name {
            font-size: 16px;
            color: #666;
        }

        .setting-description {
            font-size: 16px;
            color: #666;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #667eea;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .number-input {
            width: 100px;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .number-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: white;
            text-decoration: none;
            font-size: 14px;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .reset-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .reset-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .reset-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-reset {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-reset.danger {
            background: #dc3545;
            color: white;
        }

        .btn-reset.danger:hover {
            background: #c82333;
        }

        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .confirmation-dialog.show {
            display: flex;
        }

        .confirmation-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .confirmation-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .confirmation-message {
            font-size: 14px;
            color: #666;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .confirmation-buttons {
            display: flex;
            gap: 12px;
        }

        .btn-confirm {
            flex: 1;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-confirm.danger {
            background: #dc3545;
            color: white;
        }

        .btn-confirm.danger:hover {
            background: #c82333;
        }

        .btn-confirm.secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-confirm.secondary:hover {
            background: #e0e0e0;
        }

        /* Chores list styles */
        .chores-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .chores-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chores-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }

        .chores-section-title:hover {
            color: #667eea;
        }

        .chores-toggle-icon {
            font-size: 14px;
            transition: transform 0.3s;
        }

        .chores-toggle-icon.expanded {
            transform: rotate(90deg);
        }

        .chores-section-content {
            display: none;
            margin-top: 20px;
        }

        .chores-section-content.expanded {
            display: block;
        }

        .btn-add-chore {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-block;
        }

        .btn-add-chore:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-icon {
            font-size: 20px;
            color: #666;
        }

        .chores-table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sort-indicator {
            margin-left: 8px;
            font-size: 12px;
            opacity: 0.7;
        }

        tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f8f9ff;
        }

        tbody tr.editing {
            background-color: #fff9e6;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        td {
            padding: 16px;
            color: #333;
        }

        .chore-name {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .point-value {
            font-weight: 700;
            color: #667eea;
            font-size: 18px;
        }

        .repeat-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .repeat-daily {
            background: #e3f2fd;
            color: #1976d2;
        }

        .repeat-weekly {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .repeat-monthly {
            background: #fff3e0;
            color: #e65100;
        }

        .repeat-as_needed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .repeat-none {
            background: #f5f5f5;
            color: #666;
        }

        .editable {
            cursor: pointer;
            position: relative;
        }

        .editable:hover::after {
            content: '‚úèÔ∏è';
            position: absolute;
            right: 5px;
            font-size: 12px;
            opacity: 0.5;
        }

        .edit-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 16px;
            font-family: inherit;
        }

        .edit-select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: white;
        }

        .edit-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-save, .btn-cancel {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save {
            background: #4caf50;
            color: white;
        }

        .btn-save:hover {
            background: #45a049;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #333;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            font-weight: 700;
            line-height: 1;
            min-width: 28px;
        }

        .btn-delete:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .btn-delete:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chores-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .chores-empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .chores-empty-state-text {
            font-size: 18px;
        }

        .btn-manual-cashout {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 20px 0 0 0;
        }

        .btn-manual-cashout:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-manual-cashout:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .system-message {
            width: 30%;
            margin: 15px 0 0 auto;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .system-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .system-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        .app-footer {
            position: fixed;
            bottom: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #666;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }

        .app-footer-version {
            font-weight: 500;
        }

        .app-footer-github {
            display: none;
            color: #333;
            text-decoration: none;
            transition: transform 0.2s;
            width: 16px;
            height: 16px;
            line-height: 0;
        }

        .app-footer-github:hover {
            transform: scale(1.1);
            color: #24292e;
        }

        .app-footer-github svg {
            display: block;
        }

        .app-footer-github.visible {
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-nav">
                <a href="/" class="nav-link nav-link-left">‚Üê Home</a>
            </div>
            <h1>‚öôÔ∏è Settings</h1>
        </header>

        <div class="card">
            <div id="loading" class="loading">Loading settings...</div>
            <div id="settingsContainer" style="display: none;">
                <div id="message" class="message"></div>

                <form id="settingsForm">
                    <div class="setting-item">
                        <div class="setting-label">
                            <span class="setting-title">Automatic Daily Cash Out</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="automaticDailyCashOut">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-description">
                            When enabled, excess points (above Max Rollover Points) are automatically converted to cash at the configured time at a rate of 5 points per dollar. The remaining points (up to Max Rollover Points) are kept in the point balance.
                        </div>
                        <div class="input-group" style="margin-top: 12px;">
                            <label for="dailyCashOutTime" style="color: #666; margin-right: 8px;">Cash Out Time:</label>
                            <input type="time" id="dailyCashOutTime" class="number-input" required style="width: 180px;">
                            <span style="color: #666; margin-left: 8px;">(if automatic cash out has already run today, changing this time will not take effect until tomorrow)</span>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">
                            <span class="setting-title">Max Rollover Points</span>
                        </div>
                        <div class="setting-description">
                            Maximum number of points that can be carried over to the next day. Points above this amount will be converted to cash (if Automatic Daily Cash Out is enabled) or capped at this amount (if disabled).
                        </div>
                        <div class="input-group" style="margin-top: 12px;">
                            <input type="number" id="maxRolloverPoints" class="number-input" min="0" required>
                            <span style="color: #666;">points</span>
                        </div>
                        <div style="text-align: right;">
                            <button class="btn-manual-cashout" id="manualCashoutBtn" onclick="triggerDailyCashOut()">Run One-Time Cash Out</button>
                            <div id="systemMessage" class="system-message"></div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">
                            <span class="setting-title">Chore Cooldown Periods</span>
                        </div>
                        <div class="setting-description">
                            Specify how long chores should be on cooldown after being completed, based on their repeat interval. This prevents the same chore from being recorded too frequently.
                        </div>
                        <div style="margin-top: 16px;">
                            <div class="input-group" style="margin-bottom: 12px;">
                                <label for="dailyCooldownHours" style="min-width: 180px;" class="setting-name">Daily Cooldown:</label>
                                <input type="number" id="dailyCooldownHours" class="number-input" min="0" required>
                                <span style="color: #666;">hours</span>
                            </div>
                            <div class="input-group" style="margin-bottom: 12px;">
                                <label for="weeklyCooldownDays" style="min-width: 180px;" class="setting-name">Weekly Cooldown:</label>
                                <input type="number" id="weeklyCooldownDays" class="number-input" min="0" required>
                                <span style="color: #666;">days</span>
                            </div>
                            <div class="input-group" style="margin-bottom: 12px;">
                                <label for="monthlyCooldownDays" style="min-width: 180px;" class="setting-name">Monthly Cooldown:</label>
                                <input type="number" id="monthlyCooldownDays" class="number-input" min="0" required>
                                <span style="color: #666;">days</span>
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">
                            <span class="setting-title">Kid Permissions</span>
                        </div>
                        <div class="setting-subtitle">
                            Kids can:
                        </div>
                        <div style="margin-top: 16px;">
                            <div class="setting-label" style="margin-bottom: 16px;">
                                <span class="setting-name">Record a Chore</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="kidAllowedRecordChore">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-label" style="margin-bottom: 16px;">
                                <span class="setting-name" >Redeem Points</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="kidAllowedRedeemPoints">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-label" style="margin-bottom: 16px;">
                                <span class="setting-name">Withdraw Cash</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="kidAllowedWithdrawCash">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-label" style="margin-bottom: 16px;">
                                <span class="setting-name">View History</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="kidAllowedViewHistory">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">
                            <span class="setting-title">Email Notifications</span>
                        </div>
                        <div style="margin-top: 16px;">
                            <div class="input-group" style="margin-bottom: 12px;">
                                <label for="emailSmtpServer" style="min-width: 150px;" class="setting-name">SMTP Server:</label>
                                <input type="text" id="emailSmtpServer" class="number-input" style="width: 300px;" placeholder="smtp.gmail.com">
                            </div>
                            <div class="input-group" style="margin-bottom: 12px;">
                                <label for="emailSmtpPort" style="min-width: 150px;" class="setting-name">SMTP Port:</label>
                                <input type="number" id="emailSmtpPort" class="number-input" min="1" max="65535" placeholder="587">
                                <span style="color: #666;">(usually 587 for TLS or 465 for SSL)</span>
                            </div>
                            <div class="input-group" style="margin-bottom: 12px;">
                                <label for="emailUsername" style="min-width: 150px;" class="setting-name">Username:</label>
                                <input type="text" id="emailUsername" class="number-input" style="width: 300px;" placeholder="your.email@example.com">
                            </div>
                            <div class="input-group" style="margin-bottom: 12px;">
                                <label for="emailPassword" style="min-width: 150px;" class="setting-name">Password:</label>
                                <input type="password" id="emailPassword" class="number-input" style="width: 300px;" placeholder="Leave empty to keep existing">
                            </div>
                            <div class="input-group" style="margin-bottom: 12px;">
                                <label for="emailSenderName" style="min-width: 150px;" class="setting-name">Sender Name:</label>
                                <input type="text" id="emailSenderName" class="number-input" style="width: 300px;" placeholder="Family Chores">
                            </div>
                            <div style="margin-top: 16px;">
                                <div class="input-group" style="margin-bottom: 12px; display: flex; align-items: center; gap: 12px;">
                                    <label for="parentEmailAddresses" style="min-width: 150px;" class="setting-name">Parent Address(es):</label>
                                    <input type="text" id="parentEmailAddresses" class="number-input" style="width: 300px;" placeholder="email1@example.com, email2@example.com">
                                </div>
                                <div style="text-align: right; margin-bottom: 12px;">
                                    <button type="button" class="btn-manual-cashout" id="testEmailBtn" onclick="sendTestEmail()">Send Test Email</button>
                                    <button type="button" class="btn-manual-cashout" id="sendDigestBtn" onclick="sendDailyDigest()" style="margin-left: 10px;">Send Daily Digest</button>
                                    <div id="emailTestMessage" class="system-message"></div>
                                </div>
                                
                            </div>
                                <div class="setting-label" style="margin-bottom: 16px;">
                                    <div class="setting-subtitle">
                                        Notify immediately when:
                                    </div>
                                    </div>
                                    <div class="setting-label" style="margin-bottom: 16px;">
                                    <span class="setting-name" style="font-size: 16px;">A chore is completed</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="emailNotifyChoreCompleted">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="setting-label" style="margin-bottom: 16px;">
                                    <span class="setting-name" style="font-size: 16px;">Points are redeemed</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="emailNotifyPointsRedeemed">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="setting-label" style="margin-bottom: 16px;">
                                    <span class="setting-name" style="font-size: 16px;">Cash is withdrawn</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="emailNotifyCashWithdrawn">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="setting-label" style="margin-bottom: 16px;">
                                    <span class="setting-subtitle">Daily Digest</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="emailNotifyDailyDigest">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="setting-description">
                                    Daily digest sent at midnight with today's history and current balances
                                </div>
                    
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn-primary">Save Settings</button>
                        <button type="button" class="btn-secondary" onclick="resetForm()">Reset</button>
                    </div>
                    
                </form>

                <div class="chores-section">
                    <div class="chores-section-header">
                        <div class="chores-section-title" onclick="toggleChoresSection()">
                            <span class="chores-toggle-icon" id="choresToggleIcon">‚ñ∂</span>
                            <span>Chore List</span>
                        </div>
                        <a href="/add-chore" class="btn-add-chore">Add Chore</a>
                    </div>
                    <div class="chores-section-content" id="choresSectionContent">
                        <div id="choresLoading" class="loading" style="display: none;">Loading chores...</div>
                        <div id="choresContainer" style="display: none;">
                            <div class="search-bar">
                                <span class="search-icon">üîç</span>
                                <input type="text" id="choresSearchInput" class="search-input" placeholder="Search chores...">
                            </div>
                            <div class="chores-table-container">
                                <table id="choresTable">
                                    <thead>
                                        <tr>
                                            <th onclick="sortChoresTable('chore')">
                                                Chore
                                                <span class="sort-indicator" id="sort-chore-chores"></span>
                                            </th>
                                            <th onclick="sortChoresTable('point_value')">
                                                Point Value
                                                <span class="sort-indicator" id="sort-point_value-chores"></span>
                                            </th>
                                            <th onclick="sortChoresTable('repeat')">
                                                Repeat
                                                <span class="sort-indicator" id="sort-repeat-chores"></span>
                                            </th>
                                            <th style="width: 60px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="choresTableBody">
                                    </tbody>
                                </table>
                                <div id="choresEmptyState" class="chores-empty-state" style="display: none;">
                                    <div class="chores-empty-state-icon">üìã</div>
                                    <div class="chores-empty-state-text">No chores found.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chores-section">
                    <div class="chores-section-header">
                        <div class="chores-section-title" onclick="toggleUsersSection()">
                            <span class="chores-toggle-icon" id="usersToggleIcon">‚ñ∂</span>
                            <span>User Management</span>
                        </div>
                        <a href="/add-user" class="btn-add-chore">Add User</a>
                    </div>
                    <div class="chores-section-content" id="usersSectionContent">
                        <div id="usersLoading" class="loading" style="display: none;">Loading users...</div>
                        <div id="usersContainer" style="display: none;">
                            <div class="search-bar">
                                <span class="search-icon">üîç</span>
                                <input type="text" id="usersSearchInput" class="search-input" placeholder="Search users...">
                            </div>
                            <div class="chores-table-container">
                                <table id="usersTable">
                                    <thead>
                                        <tr>
                                            <th onclick="sortUsersTable('full_name')">
                                                Name
                                                <span class="sort-indicator" id="sort-full_name-users"></span>
                                            </th>
                                            <th onclick="sortUsersTable('balance')">
                                                Points Balance
                                                <span class="sort-indicator" id="sort-balance-users"></span>
                                            </th>
                                            <th onclick="sortUsersTable('cash_balance')">
                                                Cash Balance
                                                <span class="sort-indicator" id="sort-cash_balance-users"></span>
                                            </th>
                                            <th style="width: 60px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                    </tbody>
                                </table>
                                <div id="usersEmptyState" class="chores-empty-state" style="display: none;">
                                    <div class="chores-empty-state-icon">üë§</div>
                                    <div class="chores-empty-state-text">No users found.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="reset-section">
                    <div class="reset-section-title">DANGER ZONE!</div>
                    <div class="reset-buttons">
                        <button class="btn-reset danger" onclick="confirmResetPoints()">Reset All Points Balances</button>
                        <button class="btn-reset danger" onclick="confirmResetCash()">Reset All Cash Balances</button>
                        <button class="btn-reset danger" onclick="confirmResetTransactions()">Reset All Historical Data</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Dialog -->
        <div id="confirmationDialog" class="confirmation-dialog">
            <div class="confirmation-content">
                <div class="confirmation-title" id="confirmTitle">Confirm Reset</div>
                <div class="confirmation-message" id="confirmMessage"></div>
                <div class="confirmation-buttons">
                    <button class="btn-confirm danger" id="confirmBtn" onclick="executeReset()">Confirm</button>
                    <button class="btn-confirm secondary" onclick="closeConfirmation()">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        function showMessage(text, isError = false) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + (isError ? 'error' : 'success');
            messageDiv.style.display = 'block';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        function resetForm() {
            loadSettings();
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();

                document.getElementById('automaticDailyCashOut').checked = settings.automatic_daily_cash_out;
                // Set cash out time (format: HH:MM, convert to time input format)
                const cashOutTime = settings.daily_cash_out_time || '00:00';
                document.getElementById('dailyCashOutTime').value = cashOutTime;
                document.getElementById('maxRolloverPoints').value = settings.max_rollover_points;
                document.getElementById('dailyCooldownHours').value = settings.daily_cooldown_hours || 12;
                document.getElementById('weeklyCooldownDays').value = settings.weekly_cooldown_days || 4;
                document.getElementById('monthlyCooldownDays').value = settings.monthly_cooldown_days || 14;
                document.getElementById('kidAllowedRecordChore').checked = settings.kid_allowed_record_chore || false;
                document.getElementById('kidAllowedRedeemPoints').checked = settings.kid_allowed_redeem_points || false;
                document.getElementById('kidAllowedWithdrawCash').checked = settings.kid_allowed_withdraw_cash || false;
                document.getElementById('kidAllowedViewHistory').checked = settings.kid_allowed_view_history || false;
                
                // Email settings
                document.getElementById('emailSmtpServer').value = settings.email_smtp_server || '';
                document.getElementById('emailSmtpPort').value = settings.email_smtp_port || '587';
                document.getElementById('emailUsername').value = settings.email_username || '';
                document.getElementById('emailPassword').value = ''; // Don't populate password field
                document.getElementById('emailSenderName').value = settings.email_sender_name || 'Family Chores';
                document.getElementById('emailNotifyChoreCompleted').checked = settings.email_notify_chore_completed || false;
                document.getElementById('emailNotifyPointsRedeemed').checked = settings.email_notify_points_redeemed || false;
                document.getElementById('emailNotifyCashWithdrawn').checked = settings.email_notify_cash_withdrawn || false;
                document.getElementById('emailNotifyDailyDigest').checked = settings.email_notify_daily_digest || false;
                document.getElementById('parentEmailAddresses').value = settings.parent_email_addresses || '';

                const loadingDiv = document.getElementById('loading');
                const settingsContainer = document.getElementById('settingsContainer');

                loadingDiv.style.display = 'none';
                settingsContainer.style.display = 'block';
            } catch (error) {
                console.error('Error loading settings:', error);
                document.getElementById('loading').textContent = 'Error loading settings. Please try again.';
            }
        }

        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                automatic_daily_cash_out: document.getElementById('automaticDailyCashOut').checked,
                daily_cash_out_time: document.getElementById('dailyCashOutTime').value,
                max_rollover_points: parseInt(document.getElementById('maxRolloverPoints').value),
                daily_cooldown_hours: parseInt(document.getElementById('dailyCooldownHours').value),
                weekly_cooldown_days: parseInt(document.getElementById('weeklyCooldownDays').value),
                monthly_cooldown_days: parseInt(document.getElementById('monthlyCooldownDays').value),
                kid_allowed_record_chore: document.getElementById('kidAllowedRecordChore').checked,
                kid_allowed_redeem_points: document.getElementById('kidAllowedRedeemPoints').checked,
                kid_allowed_withdraw_cash: document.getElementById('kidAllowedWithdrawCash').checked,
                kid_allowed_view_history: document.getElementById('kidAllowedViewHistory').checked,
                email_smtp_server: document.getElementById('emailSmtpServer').value.trim(),
                email_smtp_port: document.getElementById('emailSmtpPort').value.trim(),
                email_username: document.getElementById('emailUsername').value.trim(),
                email_password: document.getElementById('emailPassword').value.trim(), // Only update if provided
                email_sender_name: document.getElementById('emailSenderName').value.trim(),
                email_notify_chore_completed: document.getElementById('emailNotifyChoreCompleted').checked,
                email_notify_points_redeemed: document.getElementById('emailNotifyPointsRedeemed').checked,
                email_notify_cash_withdrawn: document.getElementById('emailNotifyCashWithdrawn').checked,
                email_notify_daily_digest: document.getElementById('emailNotifyDailyDigest').checked,
                parent_email_addresses: document.getElementById('parentEmailAddresses').value.trim()
            };

            if (data.max_rollover_points < 0) {
                showMessage('Max rollover points must be non-negative', true);
                return;
            }

            if (data.daily_cooldown_hours < 0) {
                showMessage('Daily cooldown hours must be non-negative', true);
                return;
            }

            if (data.weekly_cooldown_days < 0) {
                showMessage('Weekly cooldown days must be non-negative', true);
                return;
            }

            if (data.monthly_cooldown_days < 0) {
                showMessage('Monthly cooldown days must be non-negative', true);
                return;
            }

            try {
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Settings saved successfully!');
                } else {
                    showMessage(result.error || 'Error saving settings', true);
                }
            } catch (error) {
                showMessage('Network error. Please try again.', true);
                console.error('Error:', error);
            }
        });

        let pendingResetType = null;
        let pendingDeleteChoreId = null;
        let pendingDeleteUserId = null;

        function confirmDeleteChore(choreId, choreName) {
            pendingDeleteChoreId = choreId;
            document.getElementById('confirmTitle').textContent = 'Delete Chore';
            document.getElementById('confirmMessage').textContent = `Are you sure you want to delete "${choreName}"? This will remove the chore from the list. Existing chore history will not be affected. This action cannot be undone.`;
            document.getElementById('confirmationDialog').classList.add('show');
        }

        function confirmDeleteUser(userId, userName) {
            pendingDeleteUserId = userId;
            document.getElementById('confirmTitle').textContent = 'Delete User';
            document.getElementById('confirmMessage').textContent = `Are you sure you want to delete "${userName}"? This will remove the user and their historical data. This action cannot be undone.`;
            document.getElementById('confirmationDialog').classList.add('show');
        }

        function confirmResetPoints() {
            pendingResetType = 'points';
            document.getElementById('confirmTitle').textContent = 'Reset All Points Balances';
            document.getElementById('confirmMessage').textContent = 'Are you sure you want to reset all users\' points balances to 0? This action cannot be undone.';
            document.getElementById('confirmationDialog').classList.add('show');
        }

        function confirmResetCash() {
            pendingResetType = 'cash';
            document.getElementById('confirmTitle').textContent = 'Reset All Cash Balances';
            document.getElementById('confirmMessage').textContent = 'Are you sure you want to reset all users\' cash balances to $0.00? This action cannot be undone.';
            document.getElementById('confirmationDialog').classList.add('show');
        }

        function confirmResetTransactions() {
            pendingResetType = 'transactions';
            document.getElementById('confirmTitle').textContent = 'Reset Historical Data';
            document.getElementById('confirmMessage').textContent = 'Are you sure you want to delete all historical data? This will remove all chore completions, point redemptions, and cash withdrawals from the history. This action cannot be undone.';
            document.getElementById('confirmationDialog').classList.add('show');
        }

        function closeConfirmation() {
            document.getElementById('confirmationDialog').classList.remove('show');
            pendingResetType = null;
            pendingDeleteChoreId = null;
            pendingDeleteUserId = null;
        }

        async function executeReset() {
            // Handle user deletion
            if (pendingDeleteUserId !== null) {
                const userId = pendingDeleteUserId;
                closeConfirmation();

                try {
                    const response = await fetch(`/api/users/${userId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showMessage('User deleted successfully!');
                        // Reload users to update the list
                        await loadUsers();
                    } else {
                        showMessage(result.error || 'Error deleting user', true);
                    }
                } catch (error) {
                    showMessage('Network error. Please try again.', true);
                    console.error('Error:', error);
                }
                return;
            }

            // Handle chore deletion
            if (pendingDeleteChoreId !== null) {
                const choreId = pendingDeleteChoreId;
                closeConfirmation();

                try {
                    const response = await fetch(`/api/chores/${choreId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showMessage('Chore deleted successfully!');
                        // Reload chores to update the list
                        await loadChores();
                    } else {
                        showMessage(result.error || 'Error deleting chore', true);
                    }
                } catch (error) {
                    showMessage('Network error. Please try again.', true);
                    console.error('Error:', error);
                }
                return;
            }

            // Handle reset operations
            if (!pendingResetType) {
                closeConfirmation();
                return;
            }

            let endpoint;
            let resetType = pendingResetType;
            
            if (pendingResetType === 'points') {
                endpoint = '/api/reset-points';
            } else if (pendingResetType === 'cash') {
                endpoint = '/api/reset-cash';
            } else if (pendingResetType === 'transactions') {
                endpoint = '/api/reset-transactions';
            } else {
                closeConfirmation();
                return;
            }
            
            closeConfirmation();

            try {
                const response = await fetch(endpoint, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    let message = result.message;
                    if (!message) {
                        if (resetType === 'points') {
                            message = 'Points balances reset successfully!';
                        } else if (resetType === 'cash') {
                            message = 'Cash balances reset successfully!';
                        } else if (resetType === 'transactions') {
                            message = 'All transactions deleted successfully!';
                        }
                    }
                    showMessage(message);
                } else {
                    showMessage(result.error || `Error resetting ${resetType}`, true);
                }
            } catch (error) {
                showMessage('Network error. Please try again.', true);
                console.error('Error:', error);
            }
        }

        // Close dialog when clicking outside
        document.getElementById('confirmationDialog').addEventListener('click', (e) => {
            if (e.target.id === 'confirmationDialog') {
                closeConfirmation();
            }
        });

        // Chores list functionality
        let allChores = [];
        let filteredChores = [];
        let choresSortColumn = null;
        let choresSortDirection = 'asc';
        let editingChoreId = null;

        function getRepeatBadgeClass(repeat) {
            if (!repeat) return 'repeat-none';
            const repeatLower = repeat.toLowerCase();
            if (repeatLower === 'daily') return 'repeat-daily';
            if (repeatLower === 'weekly') return 'repeat-weekly';
            if (repeatLower === 'monthly') return 'repeat-monthly';
            if (repeatLower === 'as_needed') return 'repeat-as_needed';
            return 'repeat-none';
        }

        function formatRepeat(repeat) {
            if (!repeat) return 'None';
            const repeatLower = repeat.toLowerCase();
            if (repeatLower === 'as_needed') return 'As Needed';
            return repeat.charAt(0).toUpperCase() + repeat.slice(1);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateChoresSortIndicator(column) {
            // Clear all indicators
            document.querySelectorAll('#choresTable .sort-indicator').forEach(ind => ind.textContent = '');
            
            if (choresSortColumn === column) {
                const indicator = document.getElementById(`sort-${column}-chores`);
                if (indicator) {
                    indicator.textContent = choresSortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
                }
            }
        }

        function sortChoresTable(column) {
            if (choresSortColumn === column) {
                choresSortDirection = choresSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                choresSortColumn = column;
                choresSortDirection = 'asc';
            }
            
            updateChoresSortIndicator(column);
            applyChoresFiltersAndSort();
        }

        function applyChoresFiltersAndSort() {
            const searchTerm = document.getElementById('choresSearchInput').value.toLowerCase();
            
            filteredChores = allChores.filter(chore => {
                const choreName = (chore.chore || '').toLowerCase();
                const repeat = formatRepeat(chore.repeat).toLowerCase();
                return choreName.includes(searchTerm) || repeat.includes(searchTerm);
            });

            // Sort
            if (choresSortColumn) {
                filteredChores.sort((a, b) => {
                    let aVal = a[choresSortColumn];
                    let bVal = b[choresSortColumn];
                    
                    // Handle null/undefined values
                    if (aVal == null) aVal = '';
                    if (bVal == null) bVal = '';
                    
                    // Handle numeric sorting for point_value
                    if (choresSortColumn === 'point_value') {
                        aVal = Number(aVal) || 0;
                        bVal = Number(bVal) || 0;
                    } else {
                        aVal = String(aVal).toLowerCase();
                        bVal = String(bVal).toLowerCase();
                    }
                    
                    if (aVal < bVal) return choresSortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return choresSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            renderChoresTable();
        }

        function renderChoresTable() {
            const tableBody = document.getElementById('choresTableBody');
            const emptyState = document.getElementById('choresEmptyState');
            const table = document.getElementById('choresTable');

            if (filteredChores.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyState.style.display = 'none';

            tableBody.innerHTML = filteredChores.map(chore => {
                const repeatClass = getRepeatBadgeClass(chore.repeat);
                const repeatText = formatRepeat(chore.repeat);
                const isEditing = editingChoreId === chore.chore_id;
                
                if (isEditing) {
                    return `
                        <tr class="editing" data-chore-id="${chore.chore_id}">
                            <td>
                                <input type="text" class="edit-input" id="edit-chore-${chore.chore_id}" 
                                       value="${escapeHtml(chore.chore)}" />
                            </td>
                            <td>
                                <input type="number" class="edit-input" id="edit-point-${chore.chore_id}" 
                                       value="${chore.point_value || 0}" min="1" />
                            </td>
                            <td>
                                <select class="edit-select" id="edit-repeat-${chore.chore_id}">
                                    <option value="as_needed" ${chore.repeat === 'as_needed' ? 'selected' : ''}>As Needed</option>
                                    <option value="daily" ${chore.repeat === 'daily' ? 'selected' : ''}>Daily</option>
                                    <option value="weekly" ${chore.repeat === 'weekly' ? 'selected' : ''}>Weekly</option>
                                    <option value="monthly" ${chore.repeat === 'monthly' ? 'selected' : ''}>Monthly</option>
                                    <option value="" ${!chore.repeat ? 'selected' : ''}>None</option>
                                </select>
                                <div class="edit-actions">
                                    <button class="btn-save" onclick="saveChore(${chore.chore_id})">Save</button>
                                    <button class="btn-cancel" onclick="cancelChoreEdit()">Cancel</button>
                                </div>
                            </td>
                            <td style="text-align: center;">
                                <button class="btn-delete" onclick="event.stopPropagation(); confirmDeleteChore(${chore.chore_id}, '${escapeHtml(chore.chore)}')" title="Delete chore">‚úï</button>
                            </td>
                        </tr>
                    `;
                }
                
                return `
                    <tr data-chore-id="${chore.chore_id}">
                        <td class="chore-name editable" onclick="startChoreEdit(${chore.chore_id}, 'chore')">
                            ${escapeHtml(chore.chore)}
                        </td>
                        <td class="point-value editable" onclick="startChoreEdit(${chore.chore_id}, 'point_value')">
                            ${chore.point_value || 0}
                        </td>
                        <td class="editable" onclick="startChoreEdit(${chore.chore_id}, 'repeat')">
                            <span class="repeat-badge ${repeatClass}">${escapeHtml(repeatText)}</span>
                        </td>
                        <td style="text-align: center;">
                            <button class="btn-delete" onclick="event.stopPropagation(); confirmDeleteChore(${chore.chore_id}, '${escapeHtml(chore.chore)}')" title="Delete chore">‚úï</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function startChoreEdit(choreId, field) {
            if (editingChoreId !== null && editingChoreId !== choreId) {
                cancelChoreEdit();
            }
            editingChoreId = choreId;
            renderChoresTable();
            
            // Focus on the appropriate input
            if (field === 'chore') {
                document.getElementById(`edit-chore-${choreId}`)?.focus();
            } else if (field === 'point_value') {
                document.getElementById(`edit-point-${choreId}`)?.focus();
            } else if (field === 'repeat') {
                document.getElementById(`edit-repeat-${choreId}`)?.focus();
            }
        }

        function cancelChoreEdit() {
            editingChoreId = null;
            renderChoresTable();
        }

        async function saveChore(choreId) {
            const choreInput = document.getElementById(`edit-chore-${choreId}`);
            const pointInput = document.getElementById(`edit-point-${choreId}`);
            const repeatSelect = document.getElementById(`edit-repeat-${choreId}`);

            if (!choreInput || !pointInput || !repeatSelect) {
                showMessage('Error: Could not find edit fields', true);
                return;
            }

            const chore = choreInput.value.trim();
            const pointValue = parseInt(pointInput.value);
            const repeat = repeatSelect.value;

            if (!chore) {
                showMessage('Chore name is required', true);
                return;
            }

            if (isNaN(pointValue) || pointValue < 1) {
                showMessage('Point value must be a positive number', true);
                return;
            }

            try {
                const response = await fetch(`/api/chores/${choreId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chore: chore,
                        point_value: pointValue,
                        repeat: repeat
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Chore updated successfully!');
                    editingChoreId = null;
                    await loadChores();
                } else {
                    showMessage(result.error || 'Error updating chore', true);
                }
            } catch (error) {
                showMessage('Network error. Please try again.', true);
                console.error('Error:', error);
            }
        }

        async function loadChores() {
            try {
                const choresLoading = document.getElementById('choresLoading');
                const choresContainer = document.getElementById('choresContainer');
                
                choresLoading.style.display = 'block';
                choresContainer.style.display = 'none';

                const response = await fetch('/api/chores');
                allChores = await response.json();

                choresLoading.style.display = 'none';
                choresContainer.style.display = 'block';

                if (allChores.length === 0) {
                    filteredChores = [];
                    renderChoresTable();
                    return;
                }

                applyChoresFiltersAndSort();

            } catch (error) {
                console.error('Error loading chores:', error);
                document.getElementById('choresLoading').textContent = 'Error loading chores. Please try again.';
            }
        }

        // Toggle chores section
        function toggleChoresSection() {
            const content = document.getElementById('choresSectionContent');
            const icon = document.getElementById('choresToggleIcon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
                // Load chores if not already loaded
                if (allChores.length === 0) {
                    loadChores();
                }
            }
        }

        // Search functionality for chores
        document.getElementById('choresSearchInput').addEventListener('input', () => {
            applyChoresFiltersAndSort();
        });

        // User management functionality
        let allUsers = [];
        let filteredUsers = [];
        let usersSortColumn = null;
        let usersSortDirection = 'asc';

        function updateUsersSortIndicator(column) {
            // Clear all indicators
            document.querySelectorAll('#usersTable .sort-indicator').forEach(ind => ind.textContent = '');
            
            if (usersSortColumn === column) {
                const indicator = document.getElementById(`sort-${column}-users`);
                if (indicator) {
                    indicator.textContent = usersSortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
                }
            }
        }

        function sortUsersTable(column) {
            if (usersSortColumn === column) {
                usersSortDirection = usersSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                usersSortColumn = column;
                usersSortDirection = 'asc';
            }
            
            updateUsersSortIndicator(column);
            applyUsersFiltersAndSort();
        }

        function applyUsersFiltersAndSort() {
            const searchTerm = document.getElementById('usersSearchInput').value.toLowerCase();
            
            filteredUsers = allUsers.filter(user => {
                const userName = (user.full_name || '').toLowerCase();
                return userName.includes(searchTerm);
            });

            // Sort
            if (usersSortColumn) {
                filteredUsers.sort((a, b) => {
                    let aVal = a[usersSortColumn];
                    let bVal = b[usersSortColumn];
                    
                    // Handle null/undefined values
                    if (aVal == null) aVal = '';
                    if (bVal == null) bVal = '';
                    
                    // Handle numeric sorting for balance and cash_balance
                    if (usersSortColumn === 'balance' || usersSortColumn === 'cash_balance') {
                        aVal = Number(aVal) || 0;
                        bVal = Number(bVal) || 0;
                    } else {
                        aVal = String(aVal).toLowerCase();
                        bVal = String(bVal).toLowerCase();
                    }
                    
                    if (aVal < bVal) return usersSortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return usersSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            renderUsersTable();
        }

        function renderUsersTable() {
            const tableBody = document.getElementById('usersTableBody');
            const emptyState = document.getElementById('usersEmptyState');
            const table = document.getElementById('usersTable');

            if (filteredUsers.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyState.style.display = 'none';

            tableBody.innerHTML = filteredUsers.map(user => {
                let avatarUrl = null;
                if (user.avatar_path) {
                    const filename = user.avatar_path.includes('/') ? user.avatar_path.split('/').pop() : user.avatar_path;
                    avatarUrl = `/avatars/${filename}`;
                }
                
                return `
                    <tr data-user-id="${user.user_id}">
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                ${avatarUrl 
                                    ? `<img src="${avatarUrl}" alt="${escapeHtml(user.full_name)}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`
                                    : `<span style="font-size: 24px;">üë§</span>`
                                }
                                <span class="chore-name">${escapeHtml(user.full_name)}</span>
                            </div>
                        </td>
                        <td class="point-value">${user.balance || 0}</td>
                        <td style="color: #4caf50; font-weight: 600;">$${(user.cash_balance || 0).toFixed(2)}</td>
                        <td style="text-align: center;">
                            <button class="btn-delete" onclick="event.stopPropagation(); confirmDeleteUser(${user.user_id}, '${escapeHtml(user.full_name).replace(/'/g, "\\'")}')" title="Delete user">‚úï</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function loadUsers() {
            try {
                const usersLoading = document.getElementById('usersLoading');
                const usersContainer = document.getElementById('usersContainer');
                
                usersLoading.style.display = 'block';
                usersContainer.style.display = 'none';

                const response = await fetch('/api/users');
                allUsers = await response.json();

                usersLoading.style.display = 'none';
                usersContainer.style.display = 'block';

                if (allUsers.length === 0) {
                    filteredUsers = [];
                    renderUsersTable();
                    return;
                }

                applyUsersFiltersAndSort();

            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersLoading').textContent = 'Error loading users. Please try again.';
            }
        }

        // Toggle users section
        function toggleUsersSection() {
            const content = document.getElementById('usersSectionContent');
            const icon = document.getElementById('usersToggleIcon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
                // Load users if not already loaded
                if (allUsers.length === 0) {
                    loadUsers();
                }
            }
        }

        // Search functionality for users
        document.getElementById('usersSearchInput').addEventListener('input', () => {
            applyUsersFiltersAndSort();
        });

        // Load settings when page loads
        loadSettings();

        async function triggerDailyCashOut() {
            const btn = document.getElementById('manualCashoutBtn');
            const messageDiv = document.getElementById('systemMessage');
            
            btn.disabled = true;
            btn.textContent = 'Processing...';
            messageDiv.className = 'system-message';
            messageDiv.style.display = 'none';

            try {
                const response = await fetch('/api/daily-cash-out', {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    messageDiv.textContent = result.message || 'Daily cash out processed successfully!';
                    messageDiv.className = 'system-message success';
                    messageDiv.style.display = 'block';
                    
                    // Hide message after 10 seconds
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 10000);
                } else {
                    messageDiv.textContent = result.error || 'Error processing daily cash out';
                    messageDiv.className = 'system-message error';
                    messageDiv.style.display = 'block';
                    
                    // Hide message after 10 seconds
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 10000);
                }
            } catch (error) {
                messageDiv.textContent = 'Network error. Please try again.';
                messageDiv.className = 'system-message error';
                messageDiv.style.display = 'block';
                console.error('Error:', error);
                
                // Hide message after 10 seconds
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 10000);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Run One-Time Cash Out';
            }
        }

        // Check role on page load - redirect kids
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/get-role');
                const result = await response.json();
                const role = result.role;
                
                if (role !== 'parent') {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error checking role:', error);
                window.location.href = '/';
            }
        });

        // Load app version and GitHub link
        async function loadAppFooter() {
            try {
                const response = await fetch('/api/version');
                const data = await response.json();
                
                const versionEl = document.getElementById('appVersion');
                const githubEl = document.getElementById('appGithub');
                
                if (versionEl) {
                    versionEl.textContent = `v${data.version}`;
                }
                
                if (githubEl) {
                    githubEl.href = data.github_url;
                    // Show GitHub icon only for parents
                    const roleResponse = await fetch('/api/get-role');
                    const roleData = await roleResponse.json();
                    if (roleData.role === 'parent') {
                        githubEl.classList.add('visible');
                    }
                }
            } catch (error) {
                console.error('Error loading app footer:', error);
            }
        }

        // Load footer on page load
        loadAppFooter();

        // Send test email
        async function sendTestEmail() {
            const btn = document.getElementById('testEmailBtn');
            const messageDiv = document.getElementById('emailTestMessage');
            const parentEmails = document.getElementById('parentEmailAddresses').value.trim();
            
            btn.disabled = true;
            btn.textContent = 'Sending...';
            messageDiv.className = 'system-message';
            messageDiv.style.display = 'none';

            // Parse comma-separated emails
            const emailList = parentEmails ? parentEmails.split(',').map(e => e.trim()).filter(e => e) : [];

            try {
                const response = await fetch('/api/send-test-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        parent_email_addresses: emailList.length > 0 ? emailList : null
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    messageDiv.textContent = result.message || `Test email sent successfully to ${emailList.length || 'all configured'} address(es)!`;
                    messageDiv.className = 'system-message success';
                    messageDiv.style.display = 'block';
                    
                    // Hide message after 10 seconds
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 10000);
                } else {
                    messageDiv.textContent = result.error || 'Error sending test email';
                    messageDiv.className = 'system-message error';
                    messageDiv.style.display = 'block';
                    
                    // Hide message after 10 seconds
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 10000);
                }
            } catch (error) {
                messageDiv.textContent = 'Network error. Please try again.';
                messageDiv.className = 'system-message error';
                messageDiv.style.display = 'block';
                console.error('Error:', error);
                
                // Hide message after 10 seconds
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 10000);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Test Email';
            }
        }

        // Send daily digest email
        async function sendDailyDigest() {
            const btn1 = document.getElementById('sendDigestBtn');
            const btn2 = document.getElementById('sendDigestBtn2');
            const messageDiv = document.getElementById('emailTestMessage');
            
            // Disable both buttons
            if (btn1) {
                btn1.disabled = true;
                btn1.textContent = 'Sending...';
            }
            if (btn2) {
                btn2.disabled = true;
                btn2.textContent = 'Sending...';
            }
            messageDiv.className = 'system-message';
            messageDiv.style.display = 'none';

            try {
                const response = await fetch('/api/send-daily-digest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    messageDiv.textContent = result.message || 'Daily digest email sent successfully!';
                    messageDiv.className = 'system-message success';
                    messageDiv.style.display = 'block';
                    
                    // Hide message after 10 seconds
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 10000);
                } else {
                    messageDiv.textContent = result.error || 'Error sending daily digest email';
                    messageDiv.className = 'system-message error';
                    messageDiv.style.display = 'block';
                    
                    // Hide message after 10 seconds
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 10000);
                }
            } catch (error) {
                messageDiv.textContent = 'Network error. Please try again.';
                messageDiv.className = 'system-message error';
                messageDiv.style.display = 'block';
                console.error('Error:', error);
                
                // Hide message after 10 seconds
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 10000);
            } finally {
                if (btn1) {
                    btn1.disabled = false;
                    btn1.textContent = 'Send Daily Digest';
                }
                if (btn2) {
                    btn2.disabled = false;
                    btn2.textContent = 'Send Daily Digest Now';
                }
            }
        }
    </script>

    <!-- App Footer -->
    <div class="app-footer">
        <span class="app-footer-version" id="appVersion">v0.9.1</span>
        <a href="#" id="appGithub" class="app-footer-github" target="_blank" rel="noopener noreferrer" title="View on GitHub">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
            </svg>
        </a>
    </div>
</body>
</html>

