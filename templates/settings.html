<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Family Chores</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
    {% include '_head_includes.html' %}
</head>
<body>
    <div class="container">
        <header>
            <div class="header-nav">
                <a href="/dashboard" class="nav-link">‚Üê Dashboard</a>
            </div>
            <h1>‚öôÔ∏è Settings</h1>
        </header>

        <div class="card">
            <div id="loading" class="loading">Loading settings...</div>
            <div id="settingsContainer" style="display: none;">
                <div id="message" class="message"></div>

                <form id="settingsForm">
                    <div class="setting-group">
                        <span class="setting-title">Parent PIN</span>
                        <div class="text-body">
                            4-digit PIN used for parent login. Leave empty to keep existing.
                        </div>
                        <div class="input-group" style="margin-top: 12px;">
                            <input type="tel" id="parentPin" class="form-input" minlength="4" maxlength="4" pattern="\d{4}" title="Enter exactly 4 digits (leave empty to keep existing)" inputmode="numeric" style="width: 140px;">
                        
                        </div>
                    </div>
                    <div class="setting-group">
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                            <span class="setting-title">Automatic Daily Cash Out</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="automaticDailyCashOut">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="text-body">
                            When enabled, excess points (above Max Rollover Points) are automatically converted to cash at midnight at a rate of 5 points per dollar. The remaining points (up to Max Rollover Points) are kept in the point balance.
                            <br>Timezone used for scheduled daily cash-out: <strong id="tzDisplay">Loading timezone...</strong>
                        </div>
                    </div>

                    <div class="setting-group">
                        <span class="setting-title">Max Rollover Points</span>                        
                        <div class="text-body">
                            Maximum number of points that can be carried over to the next day. Points above this amount will be converted to cash (if Automatic Daily Cash Out is enabled) or capped at this amount (if disabled).
                        </div>
                        <div class="input-group" style="margin-top: 12px;">
                            <input type="number" id="maxRolloverPoints" class="form-input" min="0" required style="width: 100px;">
                            <span style="color: #666;">points</span>
                        </div>
                        <div style="text-align: right;">
                            <button class="btn btn-white-on-purple btn-sm" id="manualCashoutBtn" onclick="handleDailyCashOut()">Run One-Time Cash Out</button>
                            <div id="systemMessage" class="system-message"></div>
                        </div>                        
                    </div>

                    <div class="setting-group">
                        <span class="setting-title">Chore Cooldown Periods</span>
                        <div class="text-body">
                            Specify how long chores should be on cooldown after being completed, based on their repeat interval. This prevents the same chore from being recorded too frequently.
                        </div>
                        <div style="margin-top: 16px;">
                            <div class="input-group" style="margin-bottom: 12px;">
                                <label for="dailyCooldownHours" style="min-width: 180px;" class="setting-name">Daily Cooldown:</label>
                                <input type="number" id="dailyCooldownHours" class="form-input" min="0" required style="width: 100px;">
                                <span style="color: #666;">hours</span>
                            </div>
                            <div class="input-group" style="margin-bottom: 12px;">
                                <label for="weeklyCooldownDays" style="min-width: 180px;" class="setting-name">Weekly Cooldown:</label>
                                <input type="number" id="weeklyCooldownDays" class="form-input" min="0" required style="width: 100px;">
                                <span style="color: #666;">days</span>
                            </div>
                            <div class="input-group" style="margin-bottom: 12px;">
                                <label for="monthlyCooldownDays" style="min-width: 180px;" class="setting-name">Monthly Cooldown:</label>
                                <input type="number" id="monthlyCooldownDays" class="form-input" min="0" required style="width: 100px;">
                                <span style="color: #666;">days</span>
                            </div>
                        </div>
                    </div>

                    <div class="setting-group">
                        <span class="setting-title">Kid Permissions</span>
                        <div style="margin-top: 16px;">
                            <div class="setting-entry" style="margin-bottom: 16px;">
                                <span class="setting-name">Record a Chore</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="kidAllowedRecordChore">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-entry" style="margin-bottom: 16px;">
                                <span class="setting-name" >Redeem Points</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="kidAllowedRedeemPoints">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-entry" style="margin-bottom: 16px;">
                                <span class="setting-name">Withdraw Cash</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="kidAllowedWithdrawCash">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-entry" style="margin-bottom: 16px;">
                                <span class="setting-name">View History</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="kidAllowedViewHistory">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="setting-group">
                        <div class="setting-entry">
                            <span class="setting-title">Email Notifications</span>
                        </div>
                        <div style="margin-top: 16px;">
                            <!-- Parent Email Addresses Row -->
                            <div class="input-group" style="margin-bottom: 12px; display: flex; align-items: center; gap: 12px;">
                                <label for="parentEmailAddresses" class="setting-name">Parent Address(es)</label>
                                <input type="text" id="parentEmailAddresses" class="form-input" style="max-width: 300px; flex: 1;" placeholder="email1@example.com, email2@example.com">
                            </div>
                            <div class="text-body" style="margin-bottom: 16px;">
                                Comma separated list of email addresses to receive notifications.
                            </div>
                            <!-- Chore Completed Notification Row -->
                            <div class="setting-entry" style="margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
                                <span class="setting-name" style="font-size: 16px;">Notify when a chore is completed</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="emailNotifyChoreCompleted">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <!-- Points Redeemed Notification Row -->
                            <div class="setting-entry" style="margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
                                <span class="setting-name" style="font-size: 16px;">Notify when points are redeemed</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="emailNotifyPointsRedeemed">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <!-- Cash Withdrawn Notification Row -->
                            <div class="setting-entry" style="margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
                                <span class="setting-name" style="font-size: 16px;">Notify when cash is withdrawn</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="emailNotifyCashWithdrawn">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <!-- Daily Digest Notification Row -->
                            <div class="setting-entry" style="margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
                                <span class="setting-name" style="font-size: 16px;">Send Daily Digest</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="emailNotifyDailyDigest">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="text-body" style="margin-bottom: 16px;">
                                Daily digest sent at midnight with today's history and current balances.
                                <br>Timezone used for sending daily digest: <strong id="tzDisplay2">Loading timezone...</strong>
                            </div>
                            <!-- Test Email and Digest Buttons Row -->
                            <div style="text-align: right; margin-bottom: 12px;">
                                <button type="button" class="btn btn-white-on-purple btn-sm" id="testEmailBtn" onclick="handleSendTestEmail()">Send Test Email</button>
                                <button type="button" class="btn btn-white-on-purple btn-sm" id="sendDigestBtn" onclick="handleSendDailyDigest()" style="margin-left: 10px;">Send Daily Digest</button>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn-white-on-purple">Save Settings</button>
                        <button type="button" class="btn-gray-on-cream" onclick="resetForm()">Reset</button>
                    </div>
                    
                </form>

                <div class="chores-section">
                    <div class="chores-section-header">
                        <div class="setting-title" onclick="toggleChoresSection()">
                            <span class="chores-toggle-icon" id="choresToggleIcon">‚ñ∂</span>
                            <span>Chore Management</span>
                        </div>
                        <a href="/add-chore" class="btn btn-white-on-purple">Add Chore</a>
                    </div>
                    <div class="chores-section-content" id="choresSectionContent">
                        <div id="choresLoading" class="loading" style="display: none;">Loading chores...</div>
                        <div id="choresContainer" style="display: none;">
                            <div class="search-bar">
                                <span class="search-icon">üîç</span>
                                <input type="text" id="choresSearchInput" class="search-input" placeholder="Search chores...">
                            </div>
                            <!-- Top scrollbar for horizontal scrolling on narrow screens -->
                            <div id="choresTopScroll" class="table-scroll-top">
                                <div id="choresTopScrollInner" class="table-scroll-top-inner"></div>
                            </div>
                            <div class="chores-table-container">
                                <table id="choresTable">
                                    <thead>
                                        <tr>
                                            <th onclick="sortChoresTable('chore')">
                                                Chore
                                                <span class="sort-indicator" id="sort-chore-chores"></span>
                                            </th>
                                            <th onclick="sortChoresTable('point_value')">
                                                Point Value
                                                <span class="sort-indicator" id="sort-point_value-chores"></span>
                                            </th>
                                            <th onclick="sortChoresTable('repeat')">
                                                Repeat
                                                <span class="sort-indicator" id="sort-repeat-chores"></span>
                                            </th>
                                            <th onclick="sortChoresTable('requires_approval')">
                                                Requires Parental Approval
                                                <span class="sort-indicator" id="sort-requires_approval-chores"></span>
                                            </th>
                                            <th style="width: 60px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="choresTableBody">
                                    </tbody>
                                </table>
                                <div id="choresEmptyState" class="empty-state" style="display: none;">
                                    <div class="empty-state-icon">üìã</div>
                                    <div class="empty-state-text">No chores found.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chores-section">
                    <div class="chores-section-header">
                        <div class="setting-title" onclick="toggleUsersSection()">
                            <span class="chores-toggle-icon" id="usersToggleIcon">‚ñ∂</span>
                            <span>User Management</span>
                        </div>
                        <a href="/add-user" class="btn btn-white-on-purple">Add User</a>
                    </div>
                    <div class="chores-section-content" id="usersSectionContent">
                        <div id="usersLoading" class="loading" style="display: none;">Loading users...</div>
                        <div id="usersContainer" style="display: none;">
                            <div class="search-bar">
                                <span class="search-icon">üîç</span>
                                <input type="text" id="usersSearchInput" class="search-input" placeholder="Search users...">
                            </div>
                            <!-- Top scrollbar for horizontal scrolling on narrow screens -->
                            <div id="usersTopScroll" class="table-scroll-top">
                                <div id="usersTopScrollInner" class="table-scroll-top-inner"></div>
                            </div>
                            <div class="chores-table-container">
                                <table id="usersTable">
                                    <thead>
                                        <tr>
                                            <th onclick="sortUsersTable('full_name')">
                                                Name
                                                <span class="sort-indicator" id="sort-full_name-users"></span>
                                            </th>
                                            <th onclick="sortUsersTable('balance')">
                                                Points Balance
                                                <span class="sort-indicator" id="sort-balance-users"></span>
                                            </th>
                                            <th onclick="sortUsersTable('cash_balance')">
                                                Cash Balance
                                                <span class="sort-indicator" id="sort-cash_balance-users"></span>
                                            </th>
                                            <th style="width: 60px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                    </tbody>
                                </table>
                                <div id="usersEmptyState" class="empty-state" style="display: none;">
                                    <div class="empty-state-icon">üë§</div>
                                    <div class="empty-state-text">No users found.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="reset-section">
                    <div class="setting-title">DANGER ZONE!</div>
                        <div class="reset-buttons">
                            <button class="btn btn-red-on-white" onclick="confirmResetPoints()">Reset All Points</button>
                            <button class="btn btn-red-on-white" onclick="confirmResetCash()">Reset All Cash</button>
                            <button class="btn btn-red-on-white" onclick="confirmResetTransactions()">Reset Historical Data</button>
                        </div>
                        <!-- Vertical gap between reset button groups -->
                        <div class="mb-3" aria-hidden="true"></div>
                        <div class="reset-buttons">
                            <button class="btn btn-red-on-white" onclick="resetPassword()">Reset Password</button>
                            <button class="btn btn-red-on-white" onclick="confirmSignOut()">Sign Out</button>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Dialog -->
        <div id="confirmationDialog" class="overlay">
            <div class="overlay-content">
                <div class="text-title" id="confirmTitle">Confirm Reset</div>
                <div class="text-body text-body-lg" id="confirmMessage"></div>
                <div class="confirmation-buttons">
                    <button class="btn btn-red-on-white btn-md" id="confirmBtn" onclick="executeReset()">Confirm</button>
                    <button class="btn btn-gray-on-cream btn-md" onclick="closeConfirmation()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Password Reset Dialog -->
        <div id="passwordResetDialog" class="overlay">
            <div class="overlay-content" style="max-width:480px;">
                <div class="text-title">Reset Password</div>
                <div style="margin-top:16px;">
                    <div class="input-group" style="margin-bottom:20px;">
                        <label class="label-form">Current password</label>
                        <input type="password" id="currentPasswordInput" class="form-input">
                    </div>
                    <div class="input-group" style="margin-bottom:20px;">
                        <label class="label-form">New password</label>
                        <input type="password" id="newPasswordInput" class="form-input">
                    </div>
                    <div class="input-group" style="margin-bottom:20px;">
                        <label class="label-form" style="margin-bottom:20px;">Confirm new password</label>
                        <input type="password" id="confirmNewPasswordInput" class="form-input">
                    </div>
                </div>
                <div style="margin-top:16px; display:flex; gap:8px; justify-content:flex-end;">
                    <button class="btn btn-gray-on-cream btn-md" onclick="closePasswordResetDialog()">Cancel</button>
                    <button class="btn btn-white-on-purple btn-md" id="passwordResetSubmitBtn" onclick="submitPasswordReset()">Reset Password</button>
                </div>
                <div id="passwordResetMessage" class="system-message" style="margin-top:12px;"></div>
            </div>
        </div>

    </div>

    <script>
        // showMessage is now provided by static/js/utils.js

        // showToast is now provided by static/js/utils.js

        function resetForm() {
            loadSettings();
        }

        async function loadSettings() {
            try {
                const settings = await getSettings();

                document.getElementById('automaticDailyCashOut').checked = settings.automatic_daily_cash_out;
                document.getElementById('maxRolloverPoints').value = settings.max_rollover_points;
                document.getElementById('dailyCooldownHours').value = settings.daily_cooldown_hours || 12;
                document.getElementById('weeklyCooldownDays').value = settings.weekly_cooldown_days || 4;
                document.getElementById('monthlyCooldownDays').value = settings.monthly_cooldown_days || 14;
                // Fetch kid permissions from the dedicated endpoint (may come from roles table)
                try {
                    const perms = await getPermissions();
                    document.getElementById('kidAllowedRecordChore').checked = perms.record_chore || false;
                    document.getElementById('kidAllowedRedeemPoints').checked = perms.redeem_points || false;
                    document.getElementById('kidAllowedWithdrawCash').checked = perms.withdraw_cash || false;
                    document.getElementById('kidAllowedViewHistory').checked = perms.view_history || false;
                } catch (e) {
                    // Fall back to settings values if permissions fetch fails
                    document.getElementById('kidAllowedRecordChore').checked = settings.kid_allowed_record_chore || false;
                    document.getElementById('kidAllowedRedeemPoints').checked = settings.kid_allowed_redeem_points || false;
                    document.getElementById('kidAllowedWithdrawCash').checked = settings.kid_allowed_withdraw_cash || false;
                    document.getElementById('kidAllowedViewHistory').checked = settings.kid_allowed_view_history || false;
                }
                // Parent PIN: never populate the current PIN for security; leave empty to keep existing
                document.getElementById('parentPin').value = '';
                document.getElementById('emailNotifyChoreCompleted').checked = settings.email_notify_chore_completed || false;
                document.getElementById('emailNotifyPointsRedeemed').checked = settings.email_notify_points_redeemed || false;
                document.getElementById('emailNotifyCashWithdrawn').checked = settings.email_notify_cash_withdrawn || false;
                document.getElementById('emailNotifyDailyDigest').checked = settings.email_notify_daily_digest || false;
                document.getElementById('parentEmailAddresses').value = settings.parent_email_addresses || '';

                const loadingDiv = document.getElementById('loading');
                const settingsContainer = document.getElementById('settingsContainer');

                loadingDiv.style.display = 'none';
                settingsContainer.style.display = 'block';
            } catch (error) {
                console.error('Error loading settings:', error);
                document.getElementById('loading').textContent = 'Error loading settings. Please try again.';
            }
        }

        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                automatic_daily_cash_out: document.getElementById('automaticDailyCashOut').checked,
                max_rollover_points: parseInt(document.getElementById('maxRolloverPoints').value),
                daily_cooldown_hours: parseInt(document.getElementById('dailyCooldownHours').value),
                weekly_cooldown_days: parseInt(document.getElementById('weeklyCooldownDays').value),
                monthly_cooldown_days: parseInt(document.getElementById('monthlyCooldownDays').value),
                kid_allowed_record_chore: document.getElementById('kidAllowedRecordChore').checked,
                kid_allowed_redeem_points: document.getElementById('kidAllowedRedeemPoints').checked,
                kid_allowed_withdraw_cash: document.getElementById('kidAllowedWithdrawCash').checked,
                kid_allowed_view_history: document.getElementById('kidAllowedViewHistory').checked,
                parent_pin: document.getElementById('parentPin').value.trim(),
                email_notify_chore_completed: document.getElementById('emailNotifyChoreCompleted').checked,
                email_notify_points_redeemed: document.getElementById('emailNotifyPointsRedeemed').checked,
                email_notify_cash_withdrawn: document.getElementById('emailNotifyCashWithdrawn').checked,
                email_notify_daily_digest: document.getElementById('emailNotifyDailyDigest').checked,
                parent_email_addresses: document.getElementById('parentEmailAddresses').value.trim()
            };

            if (data.max_rollover_points < 0) {
                showMessage('Max rollover points must be non-negative', true);
                return;
            }

            if (data.daily_cooldown_hours < 0) {
                showMessage('Daily cooldown hours must be non-negative', true);
                return;
            }

            if (data.weekly_cooldown_days < 0) {
                showMessage('Weekly cooldown days must be non-negative', true);
                return;
            }

            if (data.monthly_cooldown_days < 0) {
                showMessage('Monthly cooldown days must be non-negative', true);
                return;
            }

            // Validate parent PIN client-side: allow empty or exactly 4 digits
            if (data.parent_pin) {
                const pinRegex = /^\d{4}$/;
                if (!pinRegex.test(data.parent_pin)) {
                    showMessage('Parent PIN must be exactly 4 digits or left empty to keep existing', true);
                    return;
                }
            }

            try {
                const response = await updateSettings(data);
                const result = await response.json();

                if (response.ok) {
                    showToast('Settings saved successfully!');
                    // Clear sensitive inputs after a successful save
                    const parentPinEl = document.getElementById('parentPin');
                    if (parentPinEl) parentPinEl.value = '';
                } else {
                    showToast(result.error || 'Error saving settings', true);
                }
            } catch (error) {
                showToast('Network error. Please try again.', true);
                console.error('Error:', error);
            }
        });

        let pendingResetType = null;
        let pendingDeleteChoreId = null;
        let pendingDeleteUserId = null;
        let pendingSignOut = false;

        function confirmDeleteChore(choreId, choreName) {
            pendingDeleteChoreId = choreId;
            document.getElementById('confirmTitle').textContent = 'Delete Chore';
            document.getElementById('confirmMessage').textContent = `Are you sure you want to delete "${choreName}"? This will remove the chore from the list. Existing chore history will not be affected. This action cannot be undone.`;
            document.getElementById('confirmationDialog').classList.add('show');
        }

        function confirmDeleteUser(userId, userName) {
            pendingDeleteUserId = userId;
            document.getElementById('confirmTitle').textContent = 'Delete User';
            document.getElementById('confirmMessage').textContent = `Are you sure you want to delete "${userName}"? This will remove the user and their historical data. This action cannot be undone.`;
            document.getElementById('confirmationDialog').classList.add('show');
        }

        function confirmResetPoints() {
            pendingResetType = 'points';
            document.getElementById('confirmTitle').textContent = 'Reset All Points Balances';
            document.getElementById('confirmMessage').textContent = 'Are you sure you want to reset all users\' points balances to 0? This action cannot be undone.';
            document.getElementById('confirmationDialog').classList.add('show');
        }

        function confirmResetCash() {
            pendingResetType = 'cash';
            document.getElementById('confirmTitle').textContent = 'Reset All Cash Balances';
            document.getElementById('confirmMessage').textContent = 'Are you sure you want to reset all users\' cash balances to $0.00? This action cannot be undone.';
            document.getElementById('confirmationDialog').classList.add('show');
        }

        function confirmResetTransactions() {
            pendingResetType = 'transactions';
            document.getElementById('confirmTitle').textContent = 'Reset Historical Data';
            document.getElementById('confirmMessage').textContent = 'Are you sure you want to delete all historical data? This will remove all chore completions, point redemptions, and cash withdrawals from the history. This action cannot be undone.';
            document.getElementById('confirmationDialog').classList.add('show');
        }

        function confirmSignOut() {
            pendingSignOut = true;
            document.getElementById('confirmTitle').textContent = 'Sign Out';
            document.getElementById('confirmMessage').textContent = 'Are you sure you want to completely sign out of Family Chores? This will end your session and return to the login page.';
            document.getElementById('confirmationDialog').classList.add('show');
        }

        function closeConfirmation() {
            document.getElementById('confirmationDialog').classList.remove('show');
            pendingResetType = null;
            pendingDeleteChoreId = null;
            pendingDeleteUserId = null;
            pendingSignOut = false;
        }

        // Password reset UI
        function resetPassword() {
            // Clear inputs and show modal
            document.getElementById('currentPasswordInput').value = '';
            document.getElementById('newPasswordInput').value = '';
            document.getElementById('confirmNewPasswordInput').value = '';
            document.getElementById('passwordResetMessage').textContent = '';
            document.getElementById('passwordResetDialog').classList.add('show');
        }

        function closePasswordResetDialog() {
            const dlg = document.getElementById('passwordResetDialog');
            if (dlg) dlg.style.display = 'none';
        }

        async function submitPasswordReset() {
            const current = document.getElementById('currentPasswordInput').value || '';
            const nw = document.getElementById('newPasswordInput').value || '';
            const confirm = document.getElementById('confirmNewPasswordInput').value || '';
            const msgEl = document.getElementById('passwordResetMessage');

            msgEl.textContent = '';

            if (!nw) { msgEl.textContent = 'New password is required'; return; }
            if (nw !== confirm) { msgEl.textContent = 'New passwords do not match'; return; }

            // Disable submit while request in flight
            const btn = document.getElementById('passwordResetSubmitBtn');
            btn.disabled = true;
            btn.textContent = 'Resetting...';

            try {
                // Use the shared helper in static/js/utils.js
                const resp = await resetTenantPassword(current, nw);
                const data = await (resp.json().catch(() => ({})));

                if (resp.ok) {
                    showToast('Password changed successfully');
                    closePasswordResetDialog();

                    // Backend revokes refresh tokens and clears cookies; ensure client fully signs out
                    setTimeout(async () => {
                        try {
                            await tenantLogout();
                        } catch (err) {
                            // Fallback: navigate to root
                            window.location.href = '/';
                        }
                    }, 700);
                } else {
                    showToast(data.error || 'Error changing password', true);
                    msgEl.textContent = data.error || 'Error changing password';
                }
            } catch (e) {
                console.error(e);
                showToast('Network error while changing password', true);
                msgEl.textContent = 'Network error';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Reset Password';
            }
        }

        async function executeReset() {
            // Handle user deletion
            if (pendingDeleteUserId !== null) {
                const userId = pendingDeleteUserId;
                closeConfirmation();

                try {
                    const response = await deleteUser(userId);
                    const result = await response.json();

                    if (response.ok) {
                        showToast('User deleted successfully!');
                        // Reload users to update the list
                        await loadUsers();
                    } else {
                        showToast(result.error || 'Error deleting user', true);
                    }
                } catch (error) {
                    showToast('Network error. Please try again.', true);
                    console.error('Error:', error);
                }
                return;
            }

            // Handle chore deletion
            if (pendingDeleteChoreId !== null) {
                const choreId = pendingDeleteChoreId;
                closeConfirmation();

                try {
                    const response = await deleteChore(choreId);
                    const result = await response.json();

                    if (response.ok) {
                        showToast('Chore deleted successfully!');
                        // Reload chores to update the list
                        await loadChores();
                    } else {
                        showToast(result.error || 'Error deleting chore', true);
                    }
                } catch (error) {
                    showToast('Network error. Please try again.', true);
                    console.error('Error:', error);
                }
                return;
            }

            // Handle reset operations
            if (!pendingResetType) {
                // If no reset type, check for sign out
                if (pendingSignOut) {
                    closeConfirmation();
                    try {
                        // Call tenantLogout from utils.js to clear session and redirect
                        await tenantLogout();
                    } catch (err) {
                        console.error('Error during sign out:', err);
                        // Ensure dialog closed even on error
                        closeConfirmation();
                    }
                    return;
                }
                closeConfirmation();
                return;
            }

            const resetType = pendingResetType;
            closeConfirmation();

            try {
                let response;
                if (resetType === 'points') {
                    response = await resetPoints();
                } else if (resetType === 'cash') {
                    response = await resetCash();
                } else if (resetType === 'transactions') {
                    response = await resetTransactions();
                } else {
                    return;
                }

                const result = await response.json();

                if (response.ok) {
                    let message = result.message;
                    if (!message) {
                        if (resetType === 'points') {
                            message = 'Points balances reset successfully!';
                        } else if (resetType === 'cash') {
                            message = 'Cash balances reset successfully!';
                        } else if (resetType === 'transactions') {
                            message = 'All transactions deleted successfully!';
                        }
                    }
                    showToast(message);
                } else {
                    showToast(result.error || `Error resetting ${resetType}`, true);
                }
            } catch (error) {
                showToast('Network error. Please try again.', true);
                console.error('Error:', error);
            }
        }

        // Close dialog when clicking outside
        document.getElementById('confirmationDialog').addEventListener('click', (e) => {
            if (e.target.id === 'confirmationDialog') {
                closeConfirmation();
            }
        });

        // Chores list functionality
        let allChores = [];
        let filteredChores = [];
        let choresSortColumn = null;
        let choresSortDirection = 'asc';
        let editingChoreId = null;

        // getRepeatBadgeClass and formatRepeat moved to static/js/utils.js

        // escapeHtml moved to static/js/utils.js

        function updateChoresSortIndicator(column) {
            // Clear all indicators
            document.querySelectorAll('#choresTable .sort-indicator').forEach(ind => ind.textContent = '');
            
            if (choresSortColumn === column) {
                const indicator = document.getElementById(`sort-${column}-chores`);
                if (indicator) {
                    indicator.textContent = choresSortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
                }
            }
        }

        function sortChoresTable(column) {
            if (choresSortColumn === column) {
                choresSortDirection = choresSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                choresSortColumn = column;
                choresSortDirection = 'asc';
            }
            
            updateChoresSortIndicator(column);
            applyChoresFiltersAndSort();
        }

        function applyChoresFiltersAndSort() {
            const searchTerm = document.getElementById('choresSearchInput').value.toLowerCase();
            
            filteredChores = allChores.filter(chore => {
                const choreName = (chore.chore || '').toLowerCase();
                const repeat = formatRepeat(chore.repeat).toLowerCase();
                return choreName.includes(searchTerm) || repeat.includes(searchTerm);
            });

            // Sort
            if (choresSortColumn) {
                filteredChores.sort((a, b) => {
                    let aVal = a[choresSortColumn];
                    let bVal = b[choresSortColumn];
                    
                    // Handle null/undefined values
                    if (aVal == null) aVal = '';
                    if (bVal == null) bVal = '';
                    
                    // Handle numeric sorting for point_value
                    if (choresSortColumn === 'point_value') {
                        aVal = Number(aVal) || 0;
                        bVal = Number(bVal) || 0;
                    } else {
                        aVal = String(aVal).toLowerCase();
                        bVal = String(bVal).toLowerCase();
                    }
                    
                    if (aVal < bVal) return choresSortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return choresSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            renderChoresTable();
        }

        function renderChoresTable() {
            const tableBody = document.getElementById('choresTableBody');
            const emptyState = document.getElementById('choresEmptyState');
            const table = document.getElementById('choresTable');

            if (filteredChores.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyState.style.display = 'none';

            tableBody.innerHTML = filteredChores.map(chore => {
                const repeatClass = getRepeatBadgeClass(chore.repeat);
                const repeatText = formatRepeat(chore.repeat);
                const isEditing = editingChoreId === chore.chore_id;
                
                if (isEditing) {
                    return `
                        <tr data-chore-id="${chore.chore_id}">
                            <td>
                                <input type="text" class="form-input form-input-focus" id="edit-chore-${chore.chore_id}" 
                                       value="${escapeHtml(chore.chore)}" />
                            </td>
                            <td>
                                <input type="number" class="form-input form-input-focus" id="edit-point-${chore.chore_id}" 
                                       value="${chore.point_value || 0}" min="1" />
                            </td>
                            <td>
                                <select class="form-select form-select-focus" id="edit-repeat-${chore.chore_id}">
                                    <option value="as_needed" ${chore.repeat === 'as_needed' ? 'selected' : ''}>As Needed</option>
                                    <option value="daily" ${chore.repeat === 'daily' ? 'selected' : ''}>Daily</option>
                                    <option value="weekly" ${chore.repeat === 'weekly' ? 'selected' : ''}>Weekly</option>
                                    <option value="monthly" ${chore.repeat === 'monthly' ? 'selected' : ''}>Monthly</option>
                                    <option value="" ${!chore.repeat ? 'selected' : ''}>None</option>
                                </select>
                            </td>
                            <td>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="edit-requires-${chore.chore_id}" ${chore.requires_approval ? 'checked' : ''} />
                                    
                            </td>
                            <td style="text-align: center;">
                                <button class="btn-delete" onclick="event.stopPropagation(); confirmDeleteChore(${chore.chore_id}, '${escapeHtml(chore.chore)}')" title="Delete chore">‚úï</button>
                            </td>
                        </tr>
                    `;
                }
                
                return `
                    <tr data-chore-id="${chore.chore_id}">
                        <td class="chores-chore-name editable" onclick="startChoreEdit(${chore.chore_id}, 'chore')">
                            ${escapeHtml(chore.chore)}
                        </td>
                        <td class="point-value editable" onclick="startChoreEdit(${chore.chore_id}, 'point_value')">
                            ${chore.point_value || 0}
                        </td>
                        <td class="editable" onclick="startChoreEdit(${chore.chore_id}, 'repeat')">
                            <span class="badge ${repeatClass}">${escapeHtml(repeatText)}</span>
                        </td>
                        <td class="editable" onclick="startChoreEdit(${chore.chore_id}, 'requires_approval')">
                            ${chore.requires_approval ? '‚úì' : '‚úó'}
                        </td>
                        <td style="text-align: center;">
                            <button class="btn-delete" onclick="event.stopPropagation(); confirmDeleteChore(${chore.chore_id}, '${escapeHtml(chore.chore)}')" title="Delete chore">‚úï</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update top scrollbar width after render
            requestAnimationFrame(() => updateChoresTopScrollbarWidth());
        }

        function startChoreEdit(choreId, field) {
            if (editingChoreId !== null && editingChoreId !== choreId) {
                cancelChoreEdit();
            }
            editingChoreId = choreId;
            renderChoresTable();
            
            // Focus on the appropriate input
            if (field === 'chore') {
                document.getElementById(`edit-chore-${choreId}`)?.focus();
            } else if (field === 'point_value') {
                document.getElementById(`edit-point-${choreId}`)?.focus();
            } else if (field === 'repeat') {
                document.getElementById(`edit-repeat-${choreId}`)?.focus();
            } else if (field === 'requires_approval') {
                document.getElementById(`edit-requires-${choreId}`)?.focus();
            }
                        // Show floating popover with Save/Cancel under the edited row
                        showEditActionsPopover(choreId);
        }

                function cancelChoreEdit() {
                        editingChoreId = null;
                        hideEditActionsPopover();
                        renderChoresTable();
                }

                let editPopoverEl = null;
                let editPopoverHandlersBound = false;
                let editPopoverClickAwayHandler = null;
                let editPopoverFocusHandler = null;

                function isSmallScreen() {
                    try { return window.matchMedia && window.matchMedia('(max-width: 768px)').matches; } catch { return window.innerWidth <= 768; }
                }
                function ensureEditPopover() {
                    if (!editPopoverEl) {
                        editPopoverEl = document.createElement('div');
                        editPopoverEl.id = 'editActionsPopover';
                        Object.assign(editPopoverEl.style, {
                            position: 'absolute', zIndex: '1000', background: '#fff', border: '1px solid #e0e0e0',
                            boxShadow: '0 6px 20px rgba(0,0,0,0.12)', borderRadius: '10px', padding: '10px', display: 'none'
                        });
                        document.body.appendChild(editPopoverEl);
                    }
                }
                function positionEditPopoverForRow(rowEl) {
                    if (!editPopoverEl || !rowEl) return;
                    const rect = rowEl.getBoundingClientRect();
                    editPopoverEl.style.display = 'block';
                    editPopoverEl.style.width = 'auto';
                    const popRect = editPopoverEl.getBoundingClientRect();
                    const top = window.scrollY + rect.bottom + 8;
                    let left = window.scrollX + rect.left + (rect.width - popRect.width) / 2;
                    const maxLeft = window.scrollX + document.documentElement.clientWidth - popRect.width - 8;
                    left = Math.max(window.scrollX + 8, Math.min(left, maxLeft));
                    editPopoverEl.style.top = `${top}px`;
                    editPopoverEl.style.left = `${left}px`;
                }
                function positionEditPopover(choreId) {
                    const rowEl = document.querySelector(`#choresTableBody tr[data-chore-id="${choreId}"]`);
                    if (!rowEl) return;
                    let anchor = rowEl;
                    if (isSmallScreen()) {
                        const active = document.activeElement;
                        if (active && rowEl.contains(active)) anchor = active;
                    }
                    const rect = anchor.getBoundingClientRect();
                    editPopoverEl.style.display = 'block';
                    editPopoverEl.style.width = 'auto';
                    const popRect = editPopoverEl.getBoundingClientRect();
                    const top = window.scrollY + rect.bottom + 8;
                    let left = window.scrollX + rect.left + (rect.width - popRect.width) / 2;
                    const maxLeft = window.scrollX + document.documentElement.clientWidth - popRect.width - 8;
                    left = Math.max(window.scrollX + 8, Math.min(left, maxLeft));
                    editPopoverEl.style.top = `${top}px`;
                    editPopoverEl.style.left = `${left}px`;
                }
                function showEditActionsPopover(choreId) {
                    ensureEditPopover();
                    editPopoverEl.innerHTML = `<div style="display:flex; gap:8px; align-items:center; justify-content:center;">
                        <button class="btn btn-green-on-mint btn-sm" onclick="saveChore(${choreId})">Save</button>
                        <button class="btn btn-gray-on-cream btn-sm" onclick="cancelChoreEdit()">Cancel</button>
                    </div>`;
                    positionEditPopover(choreId);
                    if (!editPopoverHandlersBound) {
                        window.addEventListener('scroll', onEditPopoverReposition, { passive: true });
                        window.addEventListener('resize', onEditPopoverReposition);
                        editPopoverHandlersBound = true;
                    }
                    editPopoverEl.dataset.targetChoreId = String(choreId);
                    if (!editPopoverClickAwayHandler) {
                        editPopoverClickAwayHandler = (e) => {
                            if (!editPopoverEl || editPopoverEl.style.display === 'none') return;
                            const id = editPopoverEl.dataset.targetChoreId;
                            const row = id ? document.querySelector(`#choresTableBody tr[data-chore-id="${id}"]`) : null;
                            if (editPopoverEl.contains(e.target)) return; // clicks inside popover
                            if (row && row.contains(e.target)) return; // clicks inside edited row
                            cancelChoreEdit();
                        };
                        document.addEventListener('mousedown', editPopoverClickAwayHandler);
                    }
                    if (!editPopoverFocusHandler) {
                        editPopoverFocusHandler = (e) => {
                            if (!editPopoverEl || editPopoverEl.style.display === 'none') return;
                            if (!isSmallScreen()) return;
                            const id = editPopoverEl.dataset.targetChoreId;
                            if (!id) return;
                            const row = document.querySelector(`#choresTableBody tr[data-chore-id="${id}"]`);
                            if (row && row.contains(e.target)) {
                                positionEditPopover(id);
                            }
                        };
                        document.addEventListener('focusin', editPopoverFocusHandler, true);
                    }
                }
                function onEditPopoverReposition() {
                    if (!editPopoverEl || editPopoverEl.style.display === 'none') return;
                    const id = editPopoverEl.dataset.targetChoreId;
                    if (!id) return;
                    positionEditPopover(id);
                }
                function hideEditActionsPopover() {
                    if (editPopoverEl) {
                        editPopoverEl.style.display = 'none';
                        editPopoverEl.dataset.targetChoreId = '';
                    }
                    if (editPopoverClickAwayHandler) {
                        document.removeEventListener('mousedown', editPopoverClickAwayHandler);
                        editPopoverClickAwayHandler = null;
                    }
                    if (editPopoverFocusHandler) {
                        document.removeEventListener('focusin', editPopoverFocusHandler, true);
                        editPopoverFocusHandler = null;
                    }
                }

        async function saveChore(choreId) {
            const choreInput = document.getElementById(`edit-chore-${choreId}`);
            const pointInput = document.getElementById(`edit-point-${choreId}`);
            const repeatSelect = document.getElementById(`edit-repeat-${choreId}`);
            const requiresApprovalCheckbox = document.getElementById(`edit-requires-${choreId}`);

            if (!choreInput || !pointInput || !repeatSelect) {
                showMessage('Error: Could not find edit fields', true);
                return;
            }

            const chore = choreInput.value.trim();
            const pointValue = parseInt(pointInput.value);
            const repeat = repeatSelect.value;
            const requiresApproval = requiresApprovalCheckbox ? requiresApprovalCheckbox.checked : false;

            if (!chore) {
                showMessage('Chore name is required', true);
                return;
            }

            if (isNaN(pointValue) || pointValue < 1) {
                showMessage('Point value must be a positive number', true);
                return;
            }

            // Save current scroll position
            const scrollPosition = window.scrollY;

            try {
                const response = await updateChore(choreId, {
                    chore: chore,
                    point_value: pointValue,
                    repeat: repeat,
                    requires_approval: requiresApproval
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('Chore updated successfully!');
                    hideEditActionsPopover();
                    editingChoreId = null;
                    await loadChores();
                    // Restore scroll position
                    window.scrollTo(0, scrollPosition);
                } else {
                    showToast(result.error || 'Error updating chore', true);
                }
            } catch (error) {
                showToast('Network error. Please try again.', true);
                console.error('Error:', error);
            }
        }

        async function loadChores() {
            try {
                const choresLoading = document.getElementById('choresLoading');
                const choresContainer = document.getElementById('choresContainer');
                
                choresLoading.style.display = 'block';
                choresContainer.style.display = 'none';

                allChores = await getChores();

                choresLoading.style.display = 'none';
                choresContainer.style.display = 'block';

                if (allChores.length === 0) {
                    filteredChores = [];
                    renderChoresTable();
                    return;
                }

                applyChoresFiltersAndSort();

                // Setup top scrollbar sync for chores
                setupChoresTopScrollbar();

            } catch (error) {
                console.error('Error loading chores:', error);
                document.getElementById('choresLoading').textContent = 'Error loading chores. Please try again.';
            }
        }

        function updateChoresTopScrollbarWidth() {
            const table = document.getElementById('choresTable');
            const topInner = document.getElementById('choresTopScrollInner');
            if (table && topInner) {
                topInner.style.width = table.scrollWidth + 'px';
            }
        }

        function syncChoresScroll(source) {
            const top = document.getElementById('choresTopScroll');
            const container = document.querySelector('#choresSectionContent .chores-table-container');
            if (!top || !container) return;
            if (source === 'top') {
                container.scrollLeft = top.scrollLeft;
            } else {
                top.scrollLeft = container.scrollLeft;
            }
        }

        function setupChoresTopScrollbar() {
            const top = document.getElementById('choresTopScroll');
            const container = document.querySelector('#choresSectionContent .chores-table-container');
            if (!top || !container) return;
            if (!top.dataset.bound) {
                top.addEventListener('scroll', () => syncChoresScroll('top'), { passive: true });
                container.addEventListener('scroll', () => syncChoresScroll('bottom'), { passive: true });
                window.addEventListener('resize', updateChoresTopScrollbarWidth);
                top.dataset.bound = '1';
            }
            updateChoresTopScrollbarWidth();
        }

        // Toggle chores section
        function toggleChoresSection() {
            const content = document.getElementById('choresSectionContent');
            const icon = document.getElementById('choresToggleIcon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
                // Load chores if not already loaded
                if (allChores.length === 0) {
                    loadChores();
                }
            }
        }

        // Search functionality for chores
        document.getElementById('choresSearchInput').addEventListener('input', () => {
            applyChoresFiltersAndSort();
        });

        // User management functionality
        let allUsers = [];
        let filteredUsers = [];
        let usersSortColumn = null;
        let usersSortDirection = 'asc';

        function updateUsersSortIndicator(column) {
            // Clear all indicators
            document.querySelectorAll('#usersTable .sort-indicator').forEach(ind => ind.textContent = '');
            
            if (usersSortColumn === column) {
                const indicator = document.getElementById(`sort-${column}-users`);
                if (indicator) {
                    indicator.textContent = usersSortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
                }
            }
        }

        function sortUsersTable(column) {
            if (usersSortColumn === column) {
                usersSortDirection = usersSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                usersSortColumn = column;
                usersSortDirection = 'asc';
            }
            
            updateUsersSortIndicator(column);
            applyUsersFiltersAndSort();
        }

        function applyUsersFiltersAndSort() {
            const searchTerm = document.getElementById('usersSearchInput').value.toLowerCase();
            
            filteredUsers = allUsers.filter(user => {
                const userName = (user.full_name || '').toLowerCase();
                return userName.includes(searchTerm);
            });

            // Sort
            if (usersSortColumn) {
                filteredUsers.sort((a, b) => {
                    let aVal = a[usersSortColumn];
                    let bVal = b[usersSortColumn];
                    
                    // Handle null/undefined values
                    if (aVal == null) aVal = '';
                    if (bVal == null) bVal = '';
                    
                    // Handle numeric sorting for balance and cash_balance
                    if (usersSortColumn === 'balance' || usersSortColumn === 'cash_balance') {
                        aVal = Number(aVal) || 0;
                        bVal = Number(bVal) || 0;
                    } else {
                        aVal = String(aVal).toLowerCase();
                        bVal = String(bVal).toLowerCase();
                    }
                    
                    if (aVal < bVal) return usersSortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return usersSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            renderUsersTable();
        }

        function renderUsersTable() {
            const tableBody = document.getElementById('usersTableBody');
            const emptyState = document.getElementById('usersEmptyState');
            const table = document.getElementById('usersTable');

            if (filteredUsers.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyState.style.display = 'none';

            tableBody.innerHTML = filteredUsers.map(user => {
                let avatarUrl = null;
                if (user.avatar_path) {
                    const filename = user.avatar_path.includes('/') ? user.avatar_path.split('/').pop() : user.avatar_path;
                    avatarUrl = `/avatars/${filename}`;
                }
                
                return `
                    <tr data-user-id="${user.user_id}">
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                ${avatarUrl 
                                    ? `<img src="${avatarUrl}" alt="${escapeHtml(user.full_name)}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`
                                    : `<span style="font-size: 24px;">üë§</span>`
                                }
                                <span style="font-weight: 600; color: #333; font-size: 16px;">${escapeHtml(user.full_name)}</span>
                            </div>
                        </td>
                        <td class="point-value">${user.points_balance || 0}</td>
                        <td style="color: #4caf50; font-weight: 600;">$${(user.cash_balance || 0).toFixed(2)}</td>
                        <td style="text-align: center;">
                            <button class="btn-delete" onclick="event.stopPropagation(); confirmDeleteUser(${user.user_id}, '${escapeHtml(user.full_name).replace(/'/g, "\\'")}')" title="Delete user">‚úï</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update top scrollbar width after render
            requestAnimationFrame(() => updateUsersTopScrollbarWidth());
        }

        async function loadUsers() {
            try {
                const usersLoading = document.getElementById('usersLoading');
                const usersContainer = document.getElementById('usersContainer');
                
                usersLoading.style.display = 'block';
                usersContainer.style.display = 'none';

                allUsers = await getUsers();

                usersLoading.style.display = 'none';
                usersContainer.style.display = 'block';

                if (allUsers.length === 0) {
                    filteredUsers = [];
                    renderUsersTable();
                    return;
                }

                applyUsersFiltersAndSort();

                // Setup top scrollbar sync for users
                setupUsersTopScrollbar();

            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersLoading').textContent = 'Error loading users. Please try again.';
            }
        }

        function updateUsersTopScrollbarWidth() {
            const table = document.getElementById('usersTable');
            const topInner = document.getElementById('usersTopScrollInner');
            if (table && topInner) {
                topInner.style.width = table.scrollWidth + 'px';
            }
        }

        function syncUsersScroll(source) {
            const top = document.getElementById('usersTopScroll');
            const container = document.querySelector('#usersSectionContent .chores-table-container');
            if (!top || !container) return;
            if (source === 'top') {
                container.scrollLeft = top.scrollLeft;
            } else {
                top.scrollLeft = container.scrollLeft;
            }
        }

        function setupUsersTopScrollbar() {
            const top = document.getElementById('usersTopScroll');
            const container = document.querySelector('#usersSectionContent .chores-table-container');
            if (!top || !container) return;
            if (!top.dataset.bound) {
                top.addEventListener('scroll', () => syncUsersScroll('top'), { passive: true });
                container.addEventListener('scroll', () => syncUsersScroll('bottom'), { passive: true });
                window.addEventListener('resize', updateUsersTopScrollbarWidth);
                top.dataset.bound = '1';
            }
            updateUsersTopScrollbarWidth();
        }

        // Toggle users section
        function toggleUsersSection() {
            const content = document.getElementById('usersSectionContent');
            const icon = document.getElementById('usersToggleIcon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
                // Load users if not already loaded
                if (allUsers.length === 0) {
                    loadUsers();
                }
            }
        }

        // Search functionality for users
        document.getElementById('usersSearchInput').addEventListener('input', () => {
            applyUsersFiltersAndSort();
        });

        // Load settings when page loads
        loadSettings();

        async function handleDailyCashOut() {
            const btn = document.getElementById('manualCashoutBtn');
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                const response = await triggerDailyCashOut();
                const result = await response.json();

                if (response.ok) {
                    showToast(result.message || 'Daily cash out processed successfully!');
                } else {
                    showToast(result.error || 'Error processing daily cash out', true);
                }
            } catch (error) {
                showToast('Network error. Please try again.', true);
                console.error('Error:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Run One-Time Cash Out';
            }
        }

        // Check role on page load - redirect kids
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const role = getRole();
                
                if (role !== 'parent') {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error checking role:', error);
                window.location.href = '/';
            }
        });

        // Load app version and GitHub link
        // loadAppFooter moved to static/js/utils.js

        // Load footer on page load
        loadAppFooter();

        // Populate timezone display using shared helper in static/js/utils.js
        async function loadTzDisplay() {
            try {
                const info = await getServerTzInfo();
                if (!info) {
                    ['tzDisplay', 'tzDisplay2'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = 'Unavailable';
                    });
                    return;
                }

                // tz_offset_min is minutes east of UTC (negative = west)
                const offsetMin = Number(info.tz_offset_min) || 0;
                const absMin = Math.abs(offsetMin);
                const hrs = Math.trunc(absMin / 60);
                const mins = absMin % 60;
                const sign = offsetMin <= 0 ? '-' : '+'; // negative means west (UTC-...)
                const offsetStr = `UTC${sign}${hrs}${mins ? ':' + String(mins).padStart(2, '0') : ''}`;
                const name = info.tz_name || '';
                const tzText = name ? `${name} (${offsetStr})` : offsetStr;

                // Update both timezone display elements
                ['tzDisplay', 'tzDisplay2'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = tzText;
                });
            } catch (err) {
                console.error('Error loading TZ info:', err);
                ['tzDisplay', 'tzDisplay2'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = 'Unavailable';
                });
            }
        }

        // Call it now so the timezone appears on the settings page
        loadTzDisplay();

        // Send test email
        async function handleSendTestEmail() {
            const btn = document.getElementById('testEmailBtn');
            const parentEmails = document.getElementById('parentEmailAddresses').value.trim();
            
            btn.disabled = true;
            btn.textContent = 'Sending...';

            // Parse comma-separated emails
            const emailList = parentEmails ? parentEmails.split(',').map(e => e.trim()).filter(e => e) : [];

            try {
                const response = await sendTestEmail(emailList.length > 0 ? emailList : null);
                const result = await response.json();

                if (response.ok) {
                    showToast(result.message || `Test email sent successfully to ${emailList.length || 'all configured'} address(es)!`);
                } else {
                    showToast(result.error || 'Error sending test email', true);
                }
            } catch (error) {
                showToast('Network error. Please try again.', true);
                console.error('Error:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Test Email';
            }
        }

        // Send daily digest email
        async function handleSendDailyDigest() {
            const btn1 = document.getElementById('sendDigestBtn');
            const btn2 = document.getElementById('sendDigestBtn2');
            // Disable both buttons
            if (btn1) {
                btn1.disabled = true;
                btn1.textContent = 'Sending...';
            }
            if (btn2) {
                btn2.disabled = true;
                btn2.textContent = 'Sending...';
            }

            try {
                const response = await sendDailyDigest();
                const result = await response.json();

                if (response.ok) {
                    showToast(result.message || 'Daily digest email sent successfully!');
                } else {
                    showToast(result.error || 'Error sending daily digest email', true);
                }
            } catch (error) {
                showToast('Network error. Please try again.', true);
                console.error('Error:', error);
            } finally {
                if (btn1) {
                    btn1.disabled = false;
                    btn1.textContent = 'Send Daily Digest';
                }
                if (btn2) {
                    btn2.disabled = false;
                    btn2.textContent = 'Send Daily Digest Now';
                }
            }
        }
    </script>

    <!-- App Footer -->
    <div class="app-footer">
        <span class="app-footer-version" id="appVersion"></span>
        <a href="#" id="appGithub" class="app-footer-github" target="_blank" rel="noopener noreferrer" title="View on GitHub">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
            </svg>
        </a>
    </div>
</body>
</html>

